<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple WebSocket Client</title>
</head>
<body>
    <h1>WebSocket Client</h1>
    
    <label for="serverUrl">Server URL:</label>
    <input type="text" id="serverUrl" >
    <button id="connectButton">Connect</button>

    <div id="status">Status: Not Connected</div>
    <div id="messages"></div>

    <form id="messageForm">
        <input type="text" id="messageInput">
        <button type="submit">Send</button>
    </form>

    <script>
        let socket;
        function deg(degree) {
            const PI = 3.14159265359;
            return degree * (PI / 180.0);
        }
        
        function calculate_from_altitude(altitude) {
            const real_height = altitude * Math.tan(deg(41)) * 2;
            const real_width = altitude * Math.tan(deg(66)) * 2;
            return (real_height * real_width / 1000000).toString(); // Convert to km in string
        }
        function calculate_area(pressure){
            const seaLevelPressure = 1013.25; // Standard sea-level atmospheric pressure in hPa
            const pressureDifference = seaLevelPressure - pressure;
            // Conversion factor (linear approximation)
            const metersPerHectopascal = 8.3
            const altitude = pressureDifference * metersPerHectopascal;
            const area = calculate_from_altitude(altitude);
            return area;
        }
        function calculate_altitude(pressure){
            const seaLevelPressure = 1013.25; // Standard sea-level atmospheric pressure in hPa
            const pressureDifference = seaLevelPressure - pressure;
            // Conversion factor (linear approximation)
            const metersPerHectopascal = 8.3
            return (pressureDifference * metersPerHectopascal).toFixed(4);
        }
       // document.getElementById("connectButton").addEventListener("click", () => {
         //   const serverUrl = document.getElementById("serverUrl").value;
           // connectWebSocket(serverUrl);
        //});
        connectWebSocket("ws://192.168.1.47:3001"); // auto connect kub
        function connectWebSocket(url) {
            socket = new WebSocket(url);

            // Update status
            const statusDiv = document.getElementById("status");
            statusDiv.textContent = "Status: Connecting...";

            // Handle connection opened
            socket.addEventListener("open", () => {
                statusDiv.textContent = "Status: Connected";
            });

            // Handle messages from the server
            socket.addEventListener("message", (event) => {
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML += `<p>${event.data}</p>`;
                const match = event.data.match(/\((\d+)\)/);
                if (match){
                    const new_data = parseFloat(match[0].replace("(","").replace(")","")*0.1).toFixed(4);
                    console.log("pressure in hpa: ",new_data);
                    console.log("altitude: ",calculate_altitude(new_data),"m");
                    console.log("Area: ",calculate_area(new_data)," km^2");
                    
                }
            });
            // Handle WebSocket close event
            socket.addEventListener("close", () => {
                statusDiv.textContent = "Status: Not Connected";
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML += "<p>Connection closed</p>";
            });
        }

        // Handle form submission to send messages
        document.getElementById("messageForm").addEventListener("submit", (event) => {
            event.preventDefault();
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value;
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(message);
            } else {
                alert("WebSocket connection is not open.");
            }
            messageInput.value = "";
        });
    </script>
</body>
</html>
